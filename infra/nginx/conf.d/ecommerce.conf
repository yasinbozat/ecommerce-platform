# ============================================================
# E-Commerce Platform — Nginx Routing Config
# Dosya yolu: nginx/conf.d/ecommerce.conf
# ============================================================

# ---- Upstream Tanımları ------------------------------------
# Servisler hazır olduğunda aşağıdaki host:port'ları güncelleyin.
# Geliştirme aşamasında servisler host.docker.internal üzerinden erişilebilir.

upstream user_service {
    server user-service:8081;
}

upstream product_service {
    server product-service:8082;
}

upstream order_service {
    server order-service:8083;
}

upstream payment_service {
    server payment-service:8084;
}

upstream notification_service {
    server notification-service:8085;
}

upstream search_service {
    server search-service:8086;
}

# ---- Keycloak Token Introspection (auth_request hedefi) ----
# Nginx her korumalı isteği önce buraya gönderir.
# user-service bu endpoint'te Keycloak'a token doğrulama yapar
# ve X-User-ID, X-User-Role header'larını response'a ekler.
upstream auth_service {
    server user-service:8081;
}

# ============================================================
# ANA SERVER BLOĞU
# ============================================================
server {
    listen 80;
    server_name localhost;

    # Genel proxy ayarları
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID      $request_id;
    proxy_read_timeout 60s;
    proxy_connect_timeout 10s;

    # ---- Health Check (auth gerektirmez) -------------------
    location /health {
        return 200 '{"status":"ok"}';
        add_header Content-Type application/json;
    }

    # ---- Keycloak iç doğrulama endpoint'i -----------------
    # Bu location dışarıya açık değil, sadece auth_request için
    location = /internal/auth/validate {
        internal;
        proxy_pass              http://auth_service/internal/auth/validate;
        proxy_pass_request_body off;
        proxy_set_header        Content-Length "";
        proxy_set_header        X-Original-URI $request_uri;
        proxy_set_header        Authorization $http_authorization;
    }

    # ============================================================
    # PUBLIC ENDPOINT'LER — Auth gerektirmez
    # ============================================================

    # Keycloak auth endpoint'leri — direkt Keycloak'a yönlendir
    location /realms/ {
        proxy_pass http://keycloak:8180;
        proxy_set_header Host $host:8180;
    }

    # Ürün listeleme ve detay — herkese açık
    location ~ ^/api/v1/products(/[^/]+)?$ {
        if ($request_method = GET) {
            proxy_pass http://product_service;
            break;
        }
        # GET dışındaki metodlar auth gerektirir
        auth_request /internal/auth/validate;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_set_header X-User-ID   $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_pass http://product_service;
    }

    # Kategori listeleme — herkese açık
    location /api/v1/categories {
        if ($request_method = GET) {
            proxy_pass http://product_service;
            break;
        }
        auth_request /internal/auth/validate;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_set_header X-User-ID   $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_pass http://product_service;
    }

    # Arama — herkese açık
    location /api/v1/search/ {
        proxy_pass http://search_service;
    }

    # ============================================================
    # KORUMAL ENDPOINT'LER — Keycloak JWT gerektirir
    # ============================================================

    # User servis endpoint'leri
    location /api/v1/users/ {
        auth_request /internal/auth/validate;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_set_header X-User-ID   $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_pass http://user_service;
    }

    # Sipariş endpoint'leri
    location /api/v1/orders/ {
        auth_request /internal/auth/validate;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_set_header X-User-ID   $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_pass http://order_service;
    }

    # Ödeme endpoint'leri
    location /api/v1/payments/ {
        auth_request /internal/auth/validate;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_set_header X-User-ID   $user_id;
        proxy_set_header X-User-Role $user_role;
        proxy_pass http://payment_service;
    }

    # ============================================================
    # ADMIN ENDPOINT'LER — Admin JWT gerektirir
    # (user-service role kontrolü yapar)
    # ============================================================

    location /api/v1/admin/ {
        auth_request /internal/auth/validate;
        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;
        proxy_set_header X-User-ID   $user_id;
        proxy_set_header X-User-Role $user_role;

        # Hangi servise gideceğini path'e göre belirle
        location /api/v1/admin/products/ {
            proxy_pass http://product_service;
        }
        location /api/v1/admin/orders/ {
            proxy_pass http://order_service;
        }
        location /api/v1/admin/payments/ {
            proxy_pass http://payment_service;
        }
    }

    # ============================================================
    # HATA YÖNETİMİ
    # ============================================================
    error_page 401 = @unauthorized;
    error_page 403 = @forbidden;
    error_page 502 503 504 = @service_unavailable;

    location @unauthorized {
        return 401 '{"error":"unauthorized","message":"Geçerli bir token gereklidir"}';
        add_header Content-Type application/json;
    }

    location @forbidden {
        return 403 '{"error":"forbidden","message":"Bu işlem için yetkiniz yok"}';
        add_header Content-Type application/json;
    }

    location @service_unavailable {
        return 503 '{"error":"service_unavailable","message":"Servis şu an kullanılamıyor"}';
        add_header Content-Type application/json;
    }
}
